# Cheat Sheet

| Code                                                                                    | Explanation                                                                                                                                                                                                                                                               |
| --------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `nmap [scan types] [options] [target ip]`                                               | the scan types and options are basically flags that go towards scanning the target ip                                                                                                                                                                                     |
| `sudo nmap 10.129.2.0/24 -sn -oA tnet \| grep for \| cut -d" " -f5`                     | Scan the network range from  0 - 24, -sn disables port scanning, and -oA writes results in all formats to a file called tnet.<br><br>Then you grep for the word "for", and cut out the 5 words that are delimited with spaces<br><br>[[#Host Discovery]]<br>[[#Scan IPs]] |
| `sudo nmap -sn -oA tnet -iL hosts.lst`                                                  | `-iL` lets nmap scan through the list called `hosts.lst`.<br><br>[[#Scan IP List]]                                                                                                                                                                                        |
| 1.  `-p 22,25,28,80,139`<br>2. `-p 20-80`<br>3. `--top-ports=10`<br>4. `-F`<br>5. `-p-` | 1. List of ports<br>2. Range of ports<br>3. Top 10 ports<br>4. Fast scan \| top 100 ports<br>5. All ports<br><br>Refer to:<br>[[#Discover Open TCP Ports]]<br>[[#Host and Port Scanning]]                                                                                 |
| 1. `-oN`<br>2. `-oG`<br>3. `-oX`                                                        | 1. normal output `.nmap` extension<br>2. greppable outpot `.gnmap` extension<br>3. xml extension                                                                                                                                                                          |
| `-D RND:[int value]`                                                                    | `-D` is the Decoy Flag, and `RND:[value]` means Random value of ip addresses generated by Nmap, and our real one will be hidden in the middle of it somewhere.<br><br>[[#Decoys]]                                                                                         |
| `sudo nmap 10.129.2.28 -n -Pn -p 445 -O -S 10.129.2.200 -e tun0`                        | `-S` is to scan from a different source.<br>`-e tun0` is to pipe everything through that particular interface.<br>`-O` operation system scan                                                                                                                              |

# One Liners

```bash
nmap -p- -Pn $target -v --min-rate 1000 --max-rtt-timeout 1000ms --mx-retries 5 -oN enum/nmap.ports && sleep 5 && nmap -Pn $target -sCV -v -oN enum/nmap.services && sleep 5 && nmap -T5 -Pn $target -v --script vuln -oN enum/nmap.vulns
```

# Notes

## Use Cases

- Audit the security aspects of networks
- Simulate penetration tests
- Check firewall and IDS settings and configurations
- Types of possible connections
- Network mapping
- Response analysis
- Identify open ports
- Vulnerability assessment as well.

## Architecture

- Host discovery
- Port scanning
- Service enumeration and detection
- OS detection
- NSE interaction with target services

## Techniques

```shell-session
SCAN TECHNIQUES:
  -sS/sT/sA/sW/sM: TCP SYN/Connect()/ACK/Window/Maimon scans
  -sU: UDP Scan
  -sN/sF/sX: TCP Null, FIN, and Xmas scans
  --scanflags <flags>: Customize TCP scan flags
  -sI <zombie host[:probeport]>: Idle scan
  -sY/sZ: SCTP INIT/COOKIE-ECHO scans
  -sO: IP protocol scan
  -b <FTP relay host>: FTP bounce scan
```

- If our target sends an `SYN-ACK` flagged packet back to the scanned port, Nmap detects that the port is `open`.
- If the packet receives an `RST` flag, it is an indicator that the port is `closed`.
- If Nmap does not receive a packet back, it will display it as `filtered`. Depending on the firewall configuration, certain packets may be dropped or ignored by the firewall.

### Host Discovery

**ICMP Echo Requests are the most effective discovery methods**
<font color="#ff0000">This scanning method works only if the firewalls of the hosts allow it.</font>

#### Scan IP List

If we're  ever given a list of IPs to scan by the client, then we should be able to get nmap to scan that list.

#### Scan IPs in Terminal

##### Single

You can scan a single ip address using the following script. Use `-sn` to disable port scanning since you just want to know if the device is alive.

```shell-session
sudo nmap -sn -oA tnet 10.129.2.18
```

- When port scanning is disabled, nmap defaults to a Ping Scan (`-PE`). 
- Expect an ICMP reply back IF the pinging host is alive. 
- If you don't disable port scanning, you can't get an ICMP reply because before an ICMP request is sent, nmap would send an ARP ping, and get an ARP reply.

```shell-session
sudo nmap 10.129.2.18 -sn -oA host -PE --packet-trace
```

- You can also use the `--reason` option. This will make nmap display the reason for a specific result
- If you want to disable ARP requests and use the ICMP Ping request, you can use the `--disable-arp-ping` option.

##### Multiple

You can scan multiple IPs by listing them in series or as a range

```shell-session
sudo nmap -sn -oA tnet 10.129.2.18 10.129.2.19 10.129.2.20| grep for | cut -d" " -f5
```

or

```shell-session
sudo nmap -sn -oA tnet 10.129.2.18-20| grep for | cut -d" " -f5
```

## Host and Port Scanning

The information we need:

- Open ports and services
- Service versions
- Information provided by those services
- Operating system of our target

#### States

| State              | Meaning                                                                                                                                                                                |
| ------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Open               | Connection to the scanned port has been established. Connections can be TCP, UDP, SCTP                                                                                                 |
| Closed             | The TCP protocol indicates that the packet we received back contains an `RST` flag.                                                                                                    |
| Filtered           | Nmap cannot correctly identify whether the scanned port is open or closed because either no response is returned from the target for the port or we get an error code from the target. |
| Unfiltered         | This state of a port only occurs during the **TCP-ACK** scan and means that the port is accessible, but it cannot be determined whether it is open or closed.                          |
| Open \| Filtered   | No response, indicating a firewall or packet filter may protect the port.                                                                                                              |
| Closed \| Filtered | This state only occurs in the **IP ID idle** scans and indicates that it was impossible to determine if the scanned port is closed or filtered by a firewall.                          |

#### Port Scanning Flags

- Ports can be defined in the following ways
  - One by one `-p 22,25,28,80,139`
  - By range: `-p 20-80`
  - By top ports: `--top-ports=10`
  - Top 100 ports | Fast scan: `-F`
  - All ports: `-p-`

#### Scan Types

##### TCP Scanning

- By default Nmap uses a SYN scan when we run it as root because of the socket permissions required to create raw TCP packets.
- Otherwise, it runs a TCP scan.
- The TCP connect scan (`-sT`) would be the most accurate type of scan since it used the 3way handshake to check if a port is open or closed. Sends a SYN packet. If target sends back a SYN-ACK packet its open. RST means its closed.
- Unlike other types of scans, such as the SYN scan, the Connect scan does not leave any unfinished connections or unsent packets on the target host, which makes it less likely to be detected by intrusion detection systems (IDS) or intrusion prevention systems (IPS).
- Basically a more polite scan that doesn't disturb the systems, but still allows us to map the network.
- <mark>Can bypass firewalls to accurately determine the state of the ports. But its slow cause it has to wait for a response for every packet.</mark>
- To be able to track how our sent packets are handled, we deactivate the ICMP echo requests (`-Pn`), DNS resolution (`-n`), and ARP ping scan (`--disable-arp-ping`) again.

##### UDP Scanning

- Some system administrators sometimes forget to filter the UDP ports in addition to the TCP ones.
- Since `UDP` is a `stateless protocol` and does not require a three-way handshake like TCP. We do not receive any acknowledgment. 
- <mark>Timeout is much longer, making the whole `UDP scan` (`-sU`) much slower than the `TCP scan` (`-sS`).</mark>
- Another disadvantage of this is that we often do not get a response back because `Nmap` sends empty datagrams to the scanned UDP ports, and we do not receive any response. 
- So we cannot determine if the UDP packet has arrived at all or not. <mark>If the UDP port is `open`, we only get a response if the application is configured to do so.</mark>
- IF we have an ICMP response with error code 3 (port unreachable) we know that the port is closed.
- All other responses will have their ports marked as open | filtered.

## Evasion

- IDS - Intrusion Detection System
  - Scans network for potential attacks, analyzes them and reports detected attacks.
- IPS - Intrusion Prevention System
  - Complements IDS by deploying defensive measures if an attack is detected.
  - The analysis of such attacks is based on pattern matching and signatures. If specific patterns are detected, such as service detection, IPS may prevent the pending scan.

### Detecting IDS/IPS

- Several virtual private servers (`VPS`) with different IP addresses are recommended to determine whether such systems are on the target network during a penetration test.
- If the administrator detects such a potential attack on the target network, the first step is to block the IP address from which the potential attack comes. 
- As a result, we will no longer be able to access the network using that IP address, and our Internet Service Provider (`ISP`) will be contacted and blocked from all access to the Internet.
- `IDS systems` alone are usually there to help administrators detect potential attacks on their network. They can then decide how to handle such connections. We can trigger certain security measures from an administrator, for example, by aggressively scanning a single port and its service. Based on whether specific security measures are taken, we can detect if the network has some monitoring applications or not.
- One method to determine whether such `IPS system` is present in the target network is to scan from a single host (`VPS`). If at any time this host is blocked and has no access to the target network, we know that the administrator has taken some security measures. Accordingly, we can continue our penetration test with another `VPS`.

### Decoys

- IF an IPS should block our scans...
- Decoy scanning method (`-D`) is the right choice. With this method, Nmap generates various random IP addresses inserted into the IP header to disguise the origin of the packet sent. With this method, we can generate random (`RND`) a specific number (for example: `5`) of IP addresses separated by a colon (`:`). Our real IP address is then randomly placed between the generated IP addresses.
- The spoofed packets are often filtered out by ISPs and routers, even though they come from the same network range. Therefore, we can also specify our VPS servers' IP addresses and use them in combination with "`IP ID`" manipulation in the IP headers to scan the target.

### DNS Proxying

- By default, `Nmap` performs a reverse DNS resolution unless otherwise specified to find more important information about our target. 

- <mark style="background:#fff88f">These DNS queries are also passed in most cases because the given web server is supposed to be found and visited. The DNS queries are made over the `UDP port 53`. </mark>

- The `TCP port 53` was previously only used for the so-called "`Zone transfers`" between the DNS servers or data transfer larger than 512 bytes. 

- More and more, this is changing due to IPv6 and DNSSEC expansions. These changes cause many DNS requests to be made via TCP port 53.

- However, `Nmap` still gives us a way to specify DNS servers ourselves (`--dns-server <ns>,<ns>`). 

- This method could be fundamental to us if we are in a demilitarized zone (`DMZ`). The company's DNS servers are usually more trusted than those from the Internet. 

- So, for example, we could use them to interact with the hosts of the internal network. 

- As another example, we can use `TCP port 53` as a source port (`--source-port`) for our scans. If the administrator uses the firewall to control this port and does not filter IDS/IPS properly, our TCP packets will be trusted and passed through